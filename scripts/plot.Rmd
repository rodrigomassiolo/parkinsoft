
---
title: "Análisis de la voz"
author: "realizado por: Higia"
params: 
  data: args
  pacienteEjercicio: 1
  energy: 1
  eGemaps: 1
  chroma: 1
  audspec: 1
  prosody: 1
---
```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)

library(ggplot2)
library(knitr)
library(DBI)
mydb <- dbConnect(RMySQL::MySQL(),user='higia',password='Server123',dbname='parkinsoft', host='localhost') 

#CHROMA###########################################################################################################################################
if (params$chroma == 1) {
##datosChroma <- dbReadTable(mydb,"CHROMA") 
datosChroma = dbGetQuery(mydb,paste0("SELECT * FROM CHROMA WHERE ejerciciopaciente_id = ",params$pacienteEjercicio))
datosChroma <- datosChroma[,6:17]
resultado <- expand.grid(Tiempo_segundos = seq(0,(nrow(datosChroma)-1)/100,0.01),Tono = c('C', 'C#', 'D', 'D#', 'E' ,'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'))
resultado$intensidad <- unlist(datosChroma,use.names=FALSE)
chromagraph <- ggplot(resultado, aes(Tiempo_segundos, Tono, z= intensidad)) + geom_tile(aes(fill = intensidad)) + theme_bw() + labs(title='Chroma')

#Tono mas destacado en el tiempo

aux <- vector(length=nrow(datosChroma))
for(i in 1:nrow(datosChroma)){
  aux[i]= which.max(unlist(datosChroma[i,],use.names=FALSE)) }
datosMaxChroma <- data.frame(tiempo=seq(0,(nrow(datosChroma)-1)/100,0.01), tono = aux)
chromaLineMax <- ggplot(datosMaxChroma,aes(x=tiempo,y=tono))+geom_line()+ geom_hline(yintercept=max(datosMaxChroma$tono), linetype="dashed", color = "red") + 
  geom_hline(yintercept=min(datosMaxChroma$tono), linetype="dashed", color = "blue") + geom_hline(yintercept=mean(datosMaxChroma$tono), linetype="dashed", color = "green") + labs(title='Tono con el maxima intensidad')



#Maximos, minimos y media
aux <- matrix(nrow=12,ncol=3)

for(i in 1:12){
  aux[i,1]=max(datosChroma[,i])
  aux[i,2]=mean(datosChroma[,i])
  aux[i,3]=min(datosChroma[,i])}

resultadoMMM <- data.frame(Tono = c('C', 'C#', 'D', 'D#', 'E' ,'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'), Max = aux[,1] , Media = aux[,2], Min = aux[,3])

chromaMax <- ggplot(data = resultadoMMM ,aes(x= Tono,y=Max,fill = Max)) + geom_bar(stat = "identity") + labs(title='Maximo')
chromaMean <-ggplot(data = resultadoMMM ,aes(x= Tono,y=Media,fill = Media)) + geom_bar(stat = "identity") + labs(title='Media')
chromaMin <- ggplot(data = resultadoMMM ,aes(x= Tono,y=Min,fill = Min)) + geom_bar(stat = "identity") + labs(title='Minimo')

}
###################################################################################################################################################

#ENERGY###########################################################################################################################################
if (params$energy == 1) {
##datos <- dbReadTable(mydb,"ENERGY")
datos = dbGetQuery(mydb,paste0("SELECT * FROM ENERGY WHERE ejerciciopaciente_id = ",params$pacienteEjercicio))

datos <- datos[,5:ncol(datos)]
datos2 <- data.frame(tiempo=c(datos$frameTime),LogEnergy=c(datos$pcm_LOGenergy))
datosEnergy <- datos2
energygraph <- ggplot(datos2,aes(x=tiempo,y=LogEnergy))+geom_line()+ geom_hline(yintercept=max(datos2$LogEnergy), linetype="dashed", color = "red") + 
  geom_hline(yintercept=min(datos2$LogEnergy), linetype="dashed", color = "blue") + geom_hline(yintercept=mean(datos2$LogEnergy), linetype="dashed", color = "green") +
  scale_y_continuous(breaks=seq(round(min(datos2$LogEnergy)), round(max(datos2$LogEnergy)), 1)) + labs(title='Energia de la voz')
}
###################################################################################################################################################

#AUDSPEC###########################################################################################################################################
if (params$audspec == 1) {
##datos <- dbReadTable(mydb,"AUDSPEC")
datos = dbGetQuery(mydb,paste0("SELECT * FROM AUDSPEC WHERE ejerciciopaciente_id = ",params$pacienteEjercicio))
datos <- datos[,5:ncol(datos)]
resultadoAudspect <- expand.grid(Tiempo_segundos = seq(0,(nrow(datos)-1)/100,0.01),Espectro = seq(0,25,1))
resultadoAudspect$intensidad <- unlist(datos[,3:28],use.names=FALSE)##corregir el 3,28
audspectgraph <- ggplot(resultadoAudspect, aes(Tiempo_segundos, Espectro, z= intensidad)) + geom_tile(aes(fill = intensidad)) + theme_bw() + labs(title='AudSpect')
}
#audspectgraph <- ggplot(resultadoAudspect, aes(Tiempo_segundos, Espectro, z= intensidad)) + geom_tile(aes(fill = intensidad)) + theme_bw() + labs(title='AudSpect') + scale_fill_gradient(low="black", high="blue") 
####################################################################################################################################################

##PROSODY############################################################################################################################
#F0 con probabilidad
if (params$prosody == 1) {
##datos = dbReadTable(mydb,"PROSODY")
datos = dbGetQuery(mydb,paste0("SELECT * FROM AUDSPEC WHERE ejerciciopaciente_id = ",params$pacienteEjercicio))
datos <- datos[,5:ncol(datos)]

#paso los datos a un data frame
resultado <- expand.grid(frame =datos$frame)
resultado$F0_sma = unlist( datos$F0_sma)
resultado$voiceProb =unlist( datos$voiceProb_sma)
resultado$loudness = log(unlist( datos$pcm_loudness_sma))

#copio para poder alterar los valores
resultado2F0_Vol_Prob <- resultado

#Busco el efecto de que tengan la misma proporción
resultado2F0_Vol_Prob$voiceProb = resultado2F0_Vol_Prob$voiceProb * max(resultado$F0_sma)

#grafico probabilidad
F0_Prob = ggplot(resultado2F0_Vol_Prob, aes(frame))+
  geom_line(aes(y=resultado2F0_Vol_Prob$F0_sma,col="F0")) +
  geom_line(aes(y=resultado2F0_Vol_Prob$voiceProb,col="Proba. de voz")) +
  geom_hline(yintercept=max(resultado2F0_Vol_Prob$F0_sma), linetype="dashed", color = "blue")+
  labs(x="Frames",y="Hertz",col = "Leyenda",title = "F0 y probabilidad de voz")

#Grafico Volumen y F0
F0_Volumen = ggplot(resultado2F0_Vol_Prob, aes(frame))+
  geom_line(aes(y=resultado2F0_Vol_Prob$F0_sma,col="F0")) +
  geom_line(aes(y=resultado2F0_Vol_Prob$loudness,col="Volumen")) +
  labs(x="Frames",y="Hertz",col = "Leyenda",title = "F0 y Volumen")
}  
##############################################################################################################################################

##EGEMAPS######################################################################################################################
#Formantes
if (params$eGemaps == 1) {
##datos = dbReadTable(mydb,"EGEMAPS")
datos = dbGetQuery(mydb,paste0("SELECT * FROM EGEMAPS WHERE ejerciciopaciente_id = ",params$pacienteEjercicio))
xs   <- seq(-2*pi,0,pi/100)
wave <- 0.5*sin(datos$F1frequency_sma3nz_amean * xs) + 0.25*sin(datos$F2frequency_sma3nz_amean * xs) + 0.125 * sin(datos$F3frequency_sma3nz_amean * xs)

resultado <- expand.grid(xs = xs)
resultado$wave <- wave

formanteGraph <- ggplot(resultado,aes(x=xs,y=wave)) + geom_line() + labs(title = "Transformada de fourier con las medias de F1, F2 y F3")

resumeneGemaps <- expand.grid (NombreVariable = c ("Media F0","Media F1","Media F2","Media F3","Media de jitter Local","Desviación estándar de jitter Local en DB","Media de shimmer Local","Desviación estándar de shimmer Local en dB"))
resumeneGemaps$Valor <- c(datos$F0semitoneFrom27_5Hz_sma3nz_amean,datos$F1frequency_sma3nz_amean,datos$F2frequency_sma3nz_amean,datos$F3frequency_sma3nz_amean,datos$jitterLocal_sma3nz_amean,datos$jitterLocal_sma3nz_stddevNorm,datos$shimmerLocaldB_sma3nz_amean,datos$shimmerLocaldB_sma3nz_stddevNorm)

## Vowel
vowel <- data.frame(vocal = c('i','e','y','theta','epsilon','AE','omega','gamma','a','ce','lambda','mu','o','o abierta','alpha','alpha invertida'),
                   #(vocal = c('i','e','y','ø','ɛ','œ','ɯ','ɤ','a','ɶ','ʌ','u','o','ɔ','ɑ','ɒ'),
                    f1 = c(240,390,235,370,610,585,300,460,850,820,600,250,360,500,750,700),
                    f2 = c(2400,2300,2100,1900,1900,1710,1390,1310,1610,1530,1170,595,640,700,940,760),
                    "f2-f1" = c(2160,1910,1865,1530,1290,1125,1090,850,760,710,570,345,280,200,190,60))

#Grafico de vowel
vowelGraph <- ggplot(vowel,aes(x = f1)) + geom_point(aes(y = f2,color="vowel")) + geom_point(aes(x=datos$F1frequency_sma3nz_amean,y=datos$F2frequency_sma3nz_amean,color="paciente"))+
  labs(title = "Diagráma de vowel")
}  
#######################################################################################################################
dbDisconnect(mydb)
```


# Resumen de Gráficos y datos


```{r pressure, echo=FALSE}
#CHROMA######################################################################################
if (params$chroma == 1) {
plot(chromagraph)

kable(datosChroma[1:70,],caption="Tabla de los valores del chroma")

plot(chromaLineMax)
kable(datosMaxChroma[1:70,],caption="Tabla de los valores del chroma")

plot(chromaMax)
plot(chromaMean)
plot(chromaMin)
kable(resultadoMMM[1:12,],caption="Tabla de los valores del Altas, media y baja del Chroma")
}
#############################################################################################

#ENERGY######################################################################################
if (params$energy == 1) {
plot(energygraph)
kable(datosEnergy[1:70,],caption="Tabla de los valores del Energy")
}
#############################################################################################

#AUDSPEC#####################################################################################
if (params$audspec == 1) {
plot(audspectgraph)
kable(resultadoAudspect[1:70,],caption="Tabla de los valores del AudSpect")
}
#############################################################################################

#PROSODY####################################################################################
if (params$prosody == 1) {
plot(F0_Prob)

plot(F0_Volumen)
kable(resultado2F0_Vol_Prob[1:70,],caption="Tabla de los valores del F0 y Volumen")
}
#############################################################################################

##EGEMAPS####################################################################################
#FORMANTES
if (params$eGemaps == 1) {
plot(formanteGraph)
kable(resultado[1:70,],caption="Tabla de los valores del Formantes")
kable(resumeneGemaps[1:8,],caption="Tabla de los valores del eGemaps")
#VOWEL
plot(vowelGraph)
kable(vowel[1:16,],caption="Tabla de los valores del Vowel")
}
#############################################################################################
```


